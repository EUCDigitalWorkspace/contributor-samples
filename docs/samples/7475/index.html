<!DOCTYPE html>
<head>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<link href="../../../code-sample.css" rel="stylesheet" />
<title>Horizon 7.x Security Server Management</title>

</head>
<body
><!--
Retrieved from https://code.vmware.com/samples/7475/Horizon-7-x-Security-Server-Management
--><div class="header"
><p><a href="../..">EUC Digital Workspace developer portal</a></p
><p>/ <a href="../">Contributor Code Samples</a> /</p
></div

><h1>Horizon 7.x Security Server Management</h1
><p class="github-download"
    ><a href="https://github.com/chrisdhalstead/horizon-security-server-management">Download from GitHub</a>.</p
><div class="section readme"> Script to manage Horizon 7.x Security Servers via the View-API without needing the FLEX based Administrator Console <br /> <h3 id="user-content-horizon-security-server-management"><a class="heading-link external" href="https://github.com/chrisdhalstead/horizon-security-server-management/raw/master/README.md/#horizon-security-server-management" target="_blank" rel="noopener">horizon-security-server-management<span aria-hidden="true" class="octicon octicon-link"></span></a></h3> <p>Script to manage VMware Horizon Security Servers via the View-API</p> <p><em><strong>There is no support for this tool - it is provided as-is</strong></em></p> <p>Please provide any feedback directly to me - my contact information:</p> <p>Chris Halstead - Senior Staff Architect, VMware<br /> Email: <a href="https://raw.githubusercontent.com/chrisdhalstead/horizon-security-server-management/master/mailto:chalstead@vmware.com" class=" external" target="_blank" rel="noopener">chalstead@vmware.com</a><br /> Twitter: @chrisdhalstead <br /></p> <p>Thanks to Andrew Morgan for the assistance! @andyjmorgan<br /></p> <p>Updated May 21, 2021<br /></p> <hr /> <h3 id="user-content-problem-overview"><a class="heading-link external" href="https://github.com/chrisdhalstead/horizon-security-server-management/raw/master/README.md/#problem-overview" target="_blank" rel="noopener">Problem Overview<span aria-hidden="true" class="octicon octicon-link"></span></a></h3> <p>Due to the deprecation of Adobe Flash on 12/31/20 the VMware Horizon 7 Administrator (FLEX) will no longer be able to be used. More details are here: <a href="https://kb.vmware.com/s/article/78589" rel="noopener" class=" external" target="_blank">https://kb.vmware.com/s/article/78589</a></p> <p>It is recommended to get to a minimum of VMware Horizon 7.10 (Version 7.13 is recommended) which has an HTML5 based administrative console (Horizon Console) with feature parity with the FLEX console. There are only two features that were not ported to this new HTML5 administrative console</p> <ul> <li>ThinApp integration into Pools (ThinApp still works)</li> <li>Security Server Management</li> </ul> <p>It is recommended to move off the Horizon Security Server to the <a href="https://techzone.vmware.com/deploying-vmware-unified-access-gateway-vmware-workspace-one-operational-tutorial" rel="noopener" class=" external" target="_blank">Unified Access Gateway</a> as the Security Server is no longer supported in Horizon 8 and it is a superior solution for providing remote access. If you have existing Horizon Security Servers there is no way to manage them with the new Horizon Console HTML5 console. This script can be used to manage those existing Security Servers and create a Security Server Pairing password. These are the two features needed for adding and updating Security Server.</p> <h3 id="user-content-preparing-security-server-for-upgrade-or-reinstallation"><a class="heading-link external" href="https://github.com/chrisdhalstead/horizon-security-server-management/raw/master/README.md/#preparing-security-server-for-upgrade-or-reinstallation" target="_blank" rel="noopener">Preparing Security Server for Upgrade or Reinstallation<span aria-hidden="true" class="octicon octicon-link"></span></a></h3> <p>If you need to upgrade your security server and are looking for the &quot;Prepare for Upgrade or Reinstallation&quot; button in the admin console - it is no longer there. Thankfully, the solution is just a matter of removing IPsec rules on both the Security Server and the Connection Server that it is paired with.</p> <ol> <li> <p>Start &gt; Control Panel &gt; Windows Firewall</p> </li> <li> <p>In the left pane, click Advanced Settings</p> </li> <li> <p>Expand Windows Firewall with Advanced Services and select Connection Security Rules</p> </li> <li> <p>In the right pane, select VMware View Security Server QM Pairing with xxx.xxx.xxx.xxx. Select this rule and delete it.</p> </li> </ol> <p>Do that on both the security server and the connection server it's paired with. Then you can upgrade your security server.</p> <p>Reference: <a href="https://communities.vmware.com/t5/Horizon-Desktops-and-Apps/Security-Server-Upgrade-Problem/td-p/395429" rel="noopener" class=" external" target="_blank">https://communities.vmware.com/t5/Horizon-Desktops-and-Apps/Security-Server-Upgrade-Problem/td-p/395429</a></p> <h3 id="user-content-script-overview"><a class="heading-link external" href="https://github.com/chrisdhalstead/horizon-security-server-management/raw/master/README.md/#script-overview" target="_blank" rel="noopener">Script Overview<span aria-hidden="true" class="octicon octicon-link"></span></a></h3> <p>This is a PowerShell script that uses PowerCLI and the View-API to query and set the Security Server settings. For more information on how to setup PowerCLI check out <a href="https://blogs.vmware.com/euc/2020/01/vmware-horizon-7-powercli.html" rel="noopener" class=" external" target="_blank">this great article by my colleague Graeme Gordon</a>. There are two functions that the script can be used for.</p> <ul> <li>Setting the Security Server Pairing Password on the Connection Server you authenticate to</li> <li>Retrieve a list of Security Servers bound to the Connection Server you authenticate to <ul> <li>This is a GUI and looks very similar to same management page in the FLEX console</li> </ul> </li> </ul> <h3 id="user-content-script-usage"><a class="heading-link external" href="https://github.com/chrisdhalstead/horizon-security-server-management/raw/master/README.md/#script-usage" target="_blank" rel="noopener">Script Usage<span aria-hidden="true" class="octicon octicon-link"></span></a></h3> <ol> <li> <p>Run <code>Horizon - Manage Security Server.ps1</code></p> <p><a target="_blank" rel="noopener" href="https://github.com/chrisdhalstead/horizon-security-server-management/blob/master/Images/Menu.PNG" class=" external"><img src="https://github.com/chrisdhalstead/horizon-security-server-management/raw/master/Images/Menu.PNG" alt="Menu" style="max-width: 100%;" /></a></p> <h4 id="user-content-login-to-horizon-connection-server"><a class="heading-link external" href="https://github.com/chrisdhalstead/horizon-security-server-management/raw/master/README.md/#login-to-horizon-connection-server" target="_blank" rel="noopener">Login to Horizon Connection Server<span aria-hidden="true" class="octicon octicon-link"></span></a></h4> </li> <li> <p>Choose <strong>1</strong> to Login to a Horizon Connection Server</p> <ul> <li> <p>Enter the FQDN of a connection server (<strong>NOT a Security Server</strong>) when prompted to &quot;Enter the Horizon Server Name&quot; hit enter. If you want to set a Security Server pairing password, enter the name of the Connection Server you want to pair here.</p> </li> <li> <p>Enter the Username (samAccountName) of an account with Administrative access to the Horizon Server you are connecting to when prompted to &quot;Enter the Username&quot; hit enter</p> </li> <li> <p>Enter that users Password and click enter</p> </li> <li> <p>Enter that users Domain and click enter</p> <p>You will see that you are now logged in to Horizon - click enter to go back to the menu</p> <p><a target="_blank" rel="noopener" href="https://github.com/chrisdhalstead/horizon-security-server-management/blob/master/Images/login.PNG" class=" external"><img src="https://github.com/chrisdhalstead/horizon-security-server-management/raw/master/Images/login.PNG" alt="cs" style="max-width: 100%;" /></a></p> </li> </ul> </li> </ol> <h4 id="user-content-manage-security-servers"><a class="heading-link external" href="https://github.com/chrisdhalstead/horizon-security-server-management/raw/master/README.md/#manage-security-servers" target="_blank" rel="noopener">Manage Security Servers<span aria-hidden="true" class="octicon octicon-link"></span></a></h4> <ol> <li> <p>Enter <strong>3</strong> to manage and update the Horizon Security Servers bound to the connection server you logged in to - this will open up a GUI The GUI may behind other windows if you don't see it after hitting 3 on the menu.</p> <p><em>Note: If there are no connection servers detected you will see a message in the console &quot;No Security Servers Found&quot;</em></p> <p><a target="_blank" rel="noopener" href="https://github.com/chrisdhalstead/horizon-security-server-management/blob/master/Images/gui.PNG" class=" external"><img src="https://github.com/chrisdhalstead/horizon-security-server-management/raw/master/Images/gui.PNG" alt="gui" style="max-width: 100%;" /></a></p> </li> <li> <p>If there are Security Servers bound they will all be added to the &quot;Security Servers&quot; dropdown. If there are none - you will see &quot;No Security Servers&quot;</p> </li> <li> <p>Select the Security Server you would like to manage and click &quot;Get Details&quot; - this will populate the form.</p> <p><a target="_blank" rel="noopener" href="https://github.com/chrisdhalstead/horizon-security-server-management/blob/master/Images/viewss.PNG" class=" external"><img src="https://github.com/chrisdhalstead/horizon-security-server-management/raw/master/Images/viewss.PNG" alt="viewss" style="max-width: 100%;" /></a></p> </li> <li> <p>Review and click the &quot;Cancel&quot; button to exit without changing . You can also select different Security Servers and click &quot;Get Details&quot;</p> </li> <li> <p>To update the settings make changes to any fields you would like to update and click &quot;OK&quot;. You will be prompted if you would like to update that Security Server. Click &quot;Yes&quot; to make the changes or &quot;No&quot; to exit without making changes. All three value must NOT be empty. They are required fields and you will get a warning message if you try to set an empty value</p> <p><a target="_blank" rel="noopener" href="https://github.com/chrisdhalstead/horizon-security-server-management/blob/master/Images/update.PNG" class=" external"><img src="https://github.com/chrisdhalstead/horizon-security-server-management/raw/master/Images/update.PNG" alt="update" style="max-width: 100%;" /></a><a target="_blank" rel="noopener" href="https://github.com/chrisdhalstead/horizon-security-server-management/blob/master/Images/saved.PNG" class=" external"><img src="https://github.com/chrisdhalstead/horizon-security-server-management/raw/master/Images/saved.PNG" alt="saved" style="max-width: 100%;" /></a></p> </li> <li> <p>Make any other changes and click &quot;Cancel&quot; when ready to Exit.</p> <h4 id="user-content-set-security-server-pairing-password"><a class="heading-link external" href="https://github.com/chrisdhalstead/horizon-security-server-management/raw/master/README.md/#set-security-server-pairing-password" target="_blank" rel="noopener">Set Security Server Pairing Password<span aria-hidden="true" class="octicon octicon-link"></span></a></h4> <p><em><strong>This section is only needed when adding a new security server. It is recommended to migrate to the Unified Access Gateway. Only use the Security Server if you absolutely have to</strong></em></p> <p><strong>Make sure that you connected to the Connection Server you want to set the Security Server pairing password for with this script.</strong></p> <p>In order to add a new Security Server - you need to specify a pairing password for one-time authentication to the connection server. This password is good for 30 minutes and just a one-time password. This script allows you to set that password.</p> <p><strong>Make sure the Timezone of the connection server that you will connect to with the script is set to (UTC) Coordinated Universal Time prior to running the script on it</strong></p> <p><strong>Any other variant of the UTC time zone will not work</strong></p> <p><a target="_blank" rel="noopener" href="https://github.com/chrisdhalstead/horizon-security-server-management/blob/master/Images/Timezone.PNG" class=" external"><img src="https://github.com/chrisdhalstead/horizon-security-server-management/raw/master/Images/Timezone.PNG" alt="Timezone" style="max-width: 100%;" /></a></p> <blockquote> <p>While putting together the script I realized that the <code>pae-securityserverpairingpasswordlastchangedtime</code> parameter in the ADAM database which is used to determine when the password was last set and used to compare to the validity time is not being set properly if you connection server is not using the UTC time zone. If you leave the connection server to a non UTC time zone and run this script the password last set time will be the time zone of the connection server which almost certainly deem the password invalid. If your connection server is in a time zone other than UTC you will need to set to set it to the UTC time zone, restart the &quot;VMware Horizon View Connection Server&quot; service. Run the script to set the password, then you can change the time zone on the connection server back.</p> </blockquote> <ul> <li> <p>Enter <strong>2</strong> to specify a Security Server pairing password.</p> </li> <li> <p>You will see a pop up warning you that the Connection Server time zone needs to be set to UTC while running this script (see above)</p> </li> <li> <p>Enter the password you would like to use and hit enter</p> </li> <li> <p>The password will be set and is good for 30 minutes</p> <p><a target="_blank" rel="noopener" href="https://github.com/chrisdhalstead/horizon-security-server-management/blob/master/Images/ssppw.PNG" class=" external"><img src="https://github.com/chrisdhalstead/horizon-security-server-management/raw/master/Images/ssppw.PNG" alt="ssppw" style="max-width: 100%;" /></a></p> </li> </ul> <p>You can now install a Security Server and specify the Pairing Password you set in the script.</p> </li> </ol> <p><strong>Troubleshooting:</strong></p> <p>If the script hangs after entering credentials, you are most likely running PowerShell 7.x, this script has a problem with 7.x and works best with PowerShell 5.x.</p> <p>You can verify the password was set properly by <a href="https://kb.vmware.com/s/article/2012377" rel="noopener" class=" external" target="_blank">connecting to the ADAM database</a> on the server you set the password on.</p> <p><a target="_blank" rel="noopener" href="https://github.com/chrisdhalstead/horizon-security-server-management/blob/master/Images/ADAM2.png" class=" external"><img src="https://github.com/chrisdhalstead/horizon-security-server-management/raw/master/Images/ADAM2.png" alt="ssppw" style="max-width: 100%;" /></a></p> <ul> <li>Navigate to OU=Properties | OU=Server | Double-Click the Server name you set the password on and navigate to: <ul> <li> <code>pae-SecurityServerPairingPassword</code> - this should have an encrypted value</li> <li> <code>pae-SecurityServerPasswordLastChangedTime</code> - This is the important value, to make sure that when you double-click on it the UTC time is less that 30 minutes from the current time in UTC</li> <li> <code>pae-SecurityServerPairingPasswordTimeout</code> - This should be set to 1800 (30 minutes) if the password was set with this script.</li> </ul> </li> </ul> <p><a target="_blank" rel="noopener" href="https://github.com/chrisdhalstead/horizon-security-server-management/blob/master/Images/ADAM1.png" class=" external"><img src="https://github.com/chrisdhalstead/horizon-security-server-management/raw/master/Images/ADAM1.png" alt="ssppw" style="max-width: 100%;" /></a></p> </div><div class="sample-information"
><p class="label">Contributor</p><p
    >Chris Halstead</p
><p class="label">Platform</p><p
    >Horizon</p
><p class="label">Language</p><p
    >PowerShell</p
><p class="label">License</p><p
    >MIT</p
><p class="label">Tags</p><p
    >euc | Tech Zone | VMware Horizon | Horizon</p
></div

><div class="footer"
><p>Copyright &copy; End User Computing Digital Workspace</p
></div

></body>